<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="HppDonatApp.Views.RecipeEditorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls">
    <Page.Resources>
        <Style x:Key="FlatButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderBrush" Value="#666666" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <Style x:Key="SectionCardStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="BorderBrush" Value="#2A2A2A" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="12" />
            <Setter Property="Background" Value="#0DFFFFFF" />
        </Style>
    </Page.Resources>
    <Grid Padding="20" RowSpacing="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" ColumnSpacing="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>
            <TextBox Grid.Column="0"
                     Header="Workbook Path (.xlsx)"
                     Text="{Binding WorkbookPath, Mode=TwoWay}" />
            <Button Grid.Column="1"
                    Style="{StaticResource FlatButtonStyle}"
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,1"
                    Content="Import Workbook"
                    Command="{Binding ImportWorkbookCommand}" />
            <Button Grid.Column="2"
                    Style="{StaticResource FlatButtonStyle}"
                    VerticalAlignment="Bottom"
                    Margin="0,0,0,1"
                    Content="Hitung Modal"
                    Command="{Binding CalculateBatchCostCommand}" />
        </Grid>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="16">
                <TextBlock Text="Enterprise HPP Calculator"
                           FontSize="24"
                           FontWeight="SemiBold" />
                <Grid ColumnSpacing="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Border Grid.Column="0" Style="{StaticResource SectionCardStyle}">
                        <StackPanel>
                            <TextBlock Text="Total Bahan" Opacity="0.7" />
                            <TextBlock FontSize="20"
                                       FontWeight="SemiBold"
                                       Text="{Binding RecipeIngredients.Count}" />
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="1" Style="{StaticResource SectionCardStyle}">
                        <StackPanel>
                            <TextBlock Text="Suggested Price" Opacity="0.7" />
                            <TextBlock FontSize="20"
                                       FontWeight="SemiBold"
                                       Text="{Binding CalculationResult.SuggestedPrice}" />
                        </StackPanel>
                    </Border>
                    <Border Grid.Column="2" Style="{StaticResource SectionCardStyle}">
                        <StackPanel>
                            <TextBlock Text="Confidence Score" Opacity="0.7" />
                            <TextBlock FontSize="20"
                                       FontWeight="SemiBold"
                                       Text="{Binding CalculationResult.PricingConfidenceScore}" />
                        </StackPanel>
                    </Border>
                </Grid>

                <Grid ColumnSpacing="12" RowSpacing="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0"
                             Header="Nama Resep"
                             Text="{Binding RecipeName, Mode=TwoWay}" />
                    <TextBox Grid.Column="1"
                             Header="Deskripsi"
                             Text="{Binding RecipeDescription, Mode=TwoWay}" />
                    <CheckBox Grid.Column="2"
                              VerticalAlignment="Bottom"
                              Margin="0,0,0,4"
                              Content="Output Berdasarkan Berat Adonan"
                              IsChecked="{Binding UseWeightBasedOutput, Mode=TwoWay}" />
                </Grid>

                <Border Style="{StaticResource SectionCardStyle}">
                    <StackPanel Spacing="10">
                        <TextBlock Text="Tambah Bahan Manual"
                                   FontSize="18"
                                   FontWeight="SemiBold" />
                        <Grid ColumnSpacing="8" RowSpacing="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="2*" />
                                <ColumnDefinition Width="70" />
                                <ColumnDefinition Width="90" />
                                <ColumnDefinition Width="100" />
                                <ColumnDefinition Width="110" />
                                <ColumnDefinition Width="110" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0"
                                     Header="Nama Bahan"
                                     Text="{Binding NewIngredientName, Mode=TwoWay}" />
                            <TextBox Grid.Column="1"
                                     Header="Unit"
                                     Text="{Binding NewIngredientUnit, Mode=TwoWay}" />
                            <TextBox Grid.Column="2"
                                     Header="Jumlah"
                                     Text="{Binding NewIngredientQuantity, Mode=TwoWay}" />
                            <TextBox Grid.Column="3"
                                     Header="Netto/Pack"
                                     Text="{Binding NewIngredientPackNetQuantity, Mode=TwoWay}" />
                            <TextBox Grid.Column="4"
                                     Header="Harga/Pack"
                                     Text="{Binding NewIngredientPricePerPack, Mode=TwoWay}" />
                            <TextBox Grid.Column="5"
                                     Header="Manual Cost"
                                     Text="{Binding NewIngredientManualCost, Mode=TwoWay}" />
                            <Button Grid.Column="6"
                                    Margin="0,24,0,0"
                                    Style="{StaticResource FlatButtonStyle}"
                                    Content="Tambah Bahan"
                                    Command="{Binding AddCustomIngredientCommand}" />
                        </Grid>
                        <CheckBox Content="Masuk perhitungan berat adonan"
                                  IsChecked="{Binding NewIngredientIncludeInDoughWeight, Mode=TwoWay}" />
                    </StackPanel>
                </Border>

                <Grid ColumnSpacing="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0"
                               Text="Bahan Utama"
                               FontSize="18"
                               FontWeight="SemiBold" />
                    <Button Grid.Column="1"
                            Style="{StaticResource FlatButtonStyle}"
                            Content="Hapus Bahan Terpilih"
                            Command="{Binding RemoveIngredientCommand}" />
                </Grid>

                <controls:DataGrid AutoGenerateColumns="False"
                                   CanUserReorderColumns="False"
                                   CanUserResizeColumns="True"
                                   CanUserSortColumns="False"
                                   HeadersVisibility="Column"
                                   IsReadOnly="False"
                                   MinColumnWidth="70"
                                   GridLinesVisibility="All"
                                   ItemsSource="{Binding RecipeIngredients}"
                                   SelectedItem="{Binding SelectedIngredient, Mode=TwoWay}">
                    <controls:DataGrid.Columns>
                        <controls:DataGridTextColumn Header="No"
                                                     IsReadOnly="True"
                                                     Width="60"
                                                     Binding="{Binding DisplayOrder}" />
                        <controls:DataGridTextColumn Header="Nama Bahan"
                                                     Width="*"
                                                     Binding="{Binding IngredientName, Mode=TwoWay}" />
                        <controls:DataGridTextColumn Header="Jumlah"
                                                     Width="90"
                                                     Binding="{Binding Quantity, Mode=TwoWay}" />
                        <controls:DataGridTextColumn Header="Unit"
                                                     Width="70"
                                                     Binding="{Binding Unit, Mode=TwoWay}" />
                        <controls:DataGridTextColumn Header="Netto/Pack"
                                                     Width="110"
                                                     Binding="{Binding PackNetQuantity, Mode=TwoWay}" />
                        <controls:DataGridTextColumn Header="Harga/Pack"
                                                     Width="120"
                                                     Binding="{Binding PricePerPack, Mode=TwoWay}" />
                        <controls:DataGridTextColumn Header="Manual Cost"
                                                     Width="120"
                                                     Binding="{Binding ManualCost, Mode=TwoWay}" />
                        <controls:DataGridTextColumn Header="Total"
                                                     IsReadOnly="True"
                                                     Width="130"
                                                     Binding="{Binding TotalCost}" />
                        <controls:DataGridCheckBoxColumn Header="Dough"
                                                         Width="80"
                                                         Binding="{Binding IncludeInDoughWeight, Mode=TwoWay}" />
                    </controls:DataGrid.Columns>
                </controls:DataGrid>

                <TextBlock Text="Parameter Produksi"
                           FontSize="18"
                           FontWeight="SemiBold" />

                <Grid ColumnSpacing="12" RowSpacing="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <TextBox Grid.Row="0" Grid.Column="0"
                             Header="Berat Donat (g)"
                             Text="{Binding DonutWeightGrams, Mode=TwoWay}" />
                    <TextBox Grid.Row="0" Grid.Column="1"
                             Header="Output Teoritis"
                             Text="{Binding TheoreticalOutput, Mode=TwoWay}" />
                    <TextBox Grid.Row="0" Grid.Column="2"
                             Header="Waste Percent"
                             Text="{Binding WastePercent, Mode=TwoWay}" />
                    <TextBox Grid.Row="0" Grid.Column="3"
                             Header="Batch Multiplier"
                             Text="{Binding BatchMultiplier, Mode=TwoWay}" />
                    <TextBox Grid.Row="1" Grid.Column="0"
                             Header="Minyak Dipakai (Liter)"
                             Text="{Binding OilUsedLiters, Mode=TwoWay}" />
                    <TextBox Grid.Row="1" Grid.Column="1"
                             Header="Harga Minyak/Liter"
                             Text="{Binding OilPricePerLiter, Mode=TwoWay}" />
                    <TextBox Grid.Row="1" Grid.Column="2"
                             Header="Biaya Listrik"
                             Text="{Binding EnergyRatePerKwh, Mode=TwoWay}" />
                    <TextBox Grid.Row="1" Grid.Column="3"
                             Header="Overhead (Gas + Resiko)"
                             Text="{Binding OverheadAllocated, Mode=TwoWay}" />
                </Grid>

                <TextBlock Text="Topping"
                           FontSize="18"
                           FontWeight="SemiBold" />
                <Grid ColumnSpacing="12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0"
                             Header="Berat Topping/Donat (g)"
                             Text="{Binding ToppingWeightPerDonutGrams, Mode=TwoWay}" />
                    <TextBox Grid.Column="1"
                             Header="Berat Pack Topping (g)"
                             Text="{Binding ToppingPackWeightGrams, Mode=TwoWay}" />
                    <TextBox Grid.Column="2"
                             Header="Harga Pack Topping"
                             Text="{Binding ToppingPackPrice, Mode=TwoWay}" />
                </Grid>

                <TextBlock Text="Smart Pricing Controls"
                           FontSize="18"
                           FontWeight="SemiBold" />
                <Grid ColumnSpacing="12" RowSpacing="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <TextBox Grid.Column="0"
                             Header="Volatility (0-1)"
                             Text="{Binding PriceVolatilityPercent, Mode=TwoWay}" />
                    <TextBox Grid.Column="1"
                             Header="Risk Appetite (0-1)"
                             Text="{Binding RiskAppetitePercent, Mode=TwoWay}" />
                    <TextBox Grid.Column="2"
                             Header="Market Pressure (-0.5 to 0.5)"
                             Text="{Binding MarketPressurePercent, Mode=TwoWay}" />
                    <TextBox Grid.Column="3"
                             Header="Target Profit / Batch"
                             Text="{Binding TargetProfitPerBatch, Mode=TwoWay}" />
                    <TextBox Grid.Column="4"
                             Header="Monthly Fixed Cost"
                             Text="{Binding MonthlyFixedCost, Mode=TwoWay}" />
                </Grid>

                <TextBlock Text="Hasil"
                           FontSize="18"
                           FontWeight="SemiBold" />
                <Grid ColumnSpacing="12" RowSpacing="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Total Bahan" />
                    <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding CalculationResult.IngredientCost}" />
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Grand Total Modal" />
                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding CalculationResult.TotalBatchCost}" />
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Total Berat Adonan" />
                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding CalculationResult.DoughWeightTotal}" />
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Jumlah Donat (berat)" />
                    <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding CalculationResult.DonutCountByWeight}" />
                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Modal / Donat" />
                    <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding CalculationResult.UnitCost}" />
                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Modal Topping / Donat" />
                    <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding CalculationResult.ToppingCostPerDonut}" />
                    <TextBlock Grid.Row="6" Grid.Column="0" Text="Modal Donat + Topping" />
                    <TextBlock Grid.Row="6" Grid.Column="1" Text="{Binding CalculationResult.CostPerDonutWithTopping}" />
                    <TextBlock Grid.Row="7" Grid.Column="0" Text="Risk Buffer %" />
                    <TextBlock Grid.Row="7" Grid.Column="1" Text="{Binding CalculationResult.RiskBufferPercent}" />
                    <TextBlock Grid.Row="8" Grid.Column="0" Text="Minimum Safe Price" />
                    <TextBlock Grid.Row="8" Grid.Column="1" Text="{Binding CalculationResult.MinimumSafePrice}" />
                    <TextBlock Grid.Row="9" Grid.Column="0" Text="Harga Rekomendasi Low" />
                    <TextBlock Grid.Row="9" Grid.Column="1" Text="{Binding CalculationResult.RecommendedPriceLow}" />
                    <TextBlock Grid.Row="10" Grid.Column="0" Text="Harga Rekomendasi High" />
                    <TextBlock Grid.Row="10" Grid.Column="1" Text="{Binding CalculationResult.RecommendedPriceHigh}" />
                    <TextBlock Grid.Row="11" Grid.Column="0" Text="Suggested Konservatif" />
                    <TextBlock Grid.Row="11" Grid.Column="1" Text="{Binding CalculationResult.SuggestedPriceConservative}" />
                    <TextBlock Grid.Row="12" Grid.Column="0" Text="Suggested Agresif" />
                    <TextBlock Grid.Row="12" Grid.Column="1" Text="{Binding CalculationResult.SuggestedPriceAggressive}" />
                    <TextBlock Grid.Row="13" Grid.Column="0" Text="Profit / Batch @ Suggested" />
                    <TextBlock Grid.Row="13" Grid.Column="1" Text="{Binding CalculationResult.ProfitPerBatchAtSuggestedPrice}" />
                    <TextBlock Grid.Row="14" Grid.Column="0" Text="Units untuk Target Profit" />
                    <TextBlock Grid.Row="14" Grid.Column="1" Text="{Binding CalculationResult.UnitsForTargetProfit}" />
                    <TextBlock Grid.Row="15" Grid.Column="0" Text="Monthly Break-even Units" />
                    <TextBlock Grid.Row="15" Grid.Column="1" Text="{Binding CalculationResult.MonthlyBreakEvenUnits}" />
                    <TextBlock Grid.Row="16" Grid.Column="0" Text="Catatan Rekomendasi" />
                    <TextBlock Grid.Row="16" Grid.Column="1" Text="{Binding CalculationResult.RecommendationNote}" TextWrapping="WrapWholeWords" />
                </Grid>

                <Border Style="{StaticResource SectionCardStyle}">
                    <StackPanel Spacing="6">
                        <TextBlock Text="Operational Warnings"
                                   FontSize="16"
                                   FontWeight="SemiBold" />
                        <ItemsControl ItemsSource="{Binding CalculationResult.Warnings}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding}" TextWrapping="WrapWholeWords" />
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <Border Grid.Row="2" Padding="8" CornerRadius="4" Background="#11000000">
            <TextBlock Text="{Binding StatusMessage}" />
        </Border>
    </Grid>
</Page>
