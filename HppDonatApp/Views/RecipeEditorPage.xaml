<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="HppDonatApp.Views.RecipeEditorPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:HppDonatApp.Converters"
    xmlns:controls="using:CommunityToolkit.WinUI.UI.Controls">
    <Page.Resources>
        <converters:RupiahRoundConverter x:Key="RupiahRoundConverter" />
    </Page.Resources>

    <Grid x:Name="RootContent" Padding="12" RowSpacing="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Border
            Grid.Row="0"
            Padding="10"
            Background="{ThemeResource LayerFillColorAltBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="10">
            <Grid ColumnSpacing="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <TextBox Grid.Column="0" Header="Workbook Path (.xlsx)" Text="{Binding WorkbookPath, Mode=TwoWay}" />
                <Button Grid.Column="1" VerticalAlignment="Bottom" Command="{Binding ImportWorkbookCommand}" Content="Import Workbook" />
                <Button Grid.Column="2" VerticalAlignment="Bottom" Command="{Binding CalculateBatchCostCommand}" Content="Hitung Modal" />
                <Button Grid.Column="3" VerticalAlignment="Bottom" Command="{Binding AiPriceRecommendationCommand}" Content="AI Insight" />
                <Button Grid.Column="4" VerticalAlignment="Bottom" Command="{Binding ExportRecipeCommand}" Content="Export CSV" />
            </Grid>
        </Border>

        <Grid Grid.Row="1" ColumnSpacing="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*" />
                <ColumnDefinition Width="1.2*" />
            </Grid.ColumnDefinitions>

            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                <StackPanel Spacing="10">
                    <Border
                        Padding="10"
                        Background="{ThemeResource LayerFillColorAltBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="10">
                        <StackPanel Spacing="8">
                            <TextBlock FontSize="22" FontWeight="SemiBold" Text="Kalkulator HPP Donat Enterprise" />
                            <Grid ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <ComboBox Grid.Column="0" Header="Resep Tersimpan" ItemsSource="{Binding SavedRecipes}" DisplayMemberPath="Name" SelectedItem="{Binding SelectedRecipeSummary, Mode=TwoWay}" />
                                <Button Grid.Column="1" VerticalAlignment="Bottom" Command="{Binding LoadRecipesCommand}" Content="Refresh" />
                                <Button Grid.Column="2" VerticalAlignment="Bottom" Command="{Binding OpenSelectedRecipeCommand}" Content="Buka" />
                                <Button Grid.Column="3" VerticalAlignment="Bottom" Command="{Binding NewRecipeCommand}" Content="Baru" />
                                <Button Grid.Column="4" VerticalAlignment="Bottom" Command="{Binding SaveRecipeCommand}" Content="Simpan" />
                            </Grid>
                            <Grid ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Header="Nama Resep" Text="{Binding RecipeName, Mode=TwoWay}" />
                                <TextBox Grid.Column="1" Header="Deskripsi" Text="{Binding RecipeDescription, Mode=TwoWay}" />
                                <Button Grid.Column="2" VerticalAlignment="Bottom" Command="{Binding DeleteRecipeCommand}" Content="Hapus" />
                            </Grid>
                        </StackPanel>
                    </Border>

                    <Border
                        Padding="10"
                        Background="{ThemeResource LayerFillColorAltBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="10">
                        <StackPanel Spacing="8">
                            <TextBlock FontSize="16" FontWeight="SemiBold" Text="Tambah Bahan Manual" />
                            <Grid ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="2*" />
                                    <ColumnDefinition Width="90" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Header="Nama" Text="{Binding NewIngredientName, Mode=TwoWay}" />
                                <TextBox Grid.Column="1" Header="Unit" Text="{Binding NewIngredientUnit, Mode=TwoWay}" />
                                <TextBox Grid.Column="2" Header="Qty" Text="{Binding NewIngredientQuantity, Mode=TwoWay}" />
                                <TextBox Grid.Column="3" Header="Netto/Pack" Text="{Binding NewIngredientPackNetQuantity, Mode=TwoWay}" />
                                <TextBox Grid.Column="4" Header="Harga/Pack" Text="{Binding NewIngredientPricePerPack, Mode=TwoWay}" />
                                <TextBox Grid.Column="5" Header="Manual Cost" Text="{Binding NewIngredientManualCost, Mode=TwoWay}" />
                                <Button Grid.Column="6" Margin="0,24,0,0" Command="{Binding AddCustomIngredientCommand}" Content="Tambah" />
                            </Grid>
                            <CheckBox Content="Masuk perhitungan berat adonan" IsChecked="{Binding NewIngredientIncludeInDoughWeight, Mode=TwoWay}" />
                        </StackPanel>
                    </Border>

                    <Border
                        Padding="10"
                        Background="{ThemeResource LayerFillColorAltBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="10">
                        <StackPanel Spacing="8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" FontSize="16" FontWeight="SemiBold" Text="Bahan Utama" />
                                <Button Grid.Column="1" Command="{Binding RemoveIngredientCommand}" Content="Hapus Terpilih" />
                            </Grid>
                            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                                <controls:DataGrid
                                    MinWidth="1360"
                                    AutoGenerateColumns="False"
                                    GridLinesVisibility="All"
                                    ItemsSource="{Binding RecipeIngredients}"
                                    RowHeight="36"
                                    SelectedItem="{Binding SelectedIngredient, Mode=TwoWay}">
                                    <controls:DataGrid.Columns>
                                        <controls:DataGridTextColumn Width="60" Header="No" Binding="{Binding DisplayOrder}" IsReadOnly="True" />
                                        <controls:DataGridTextColumn Width="280" Header="Nama Bahan" Binding="{Binding IngredientName, Mode=TwoWay}" />
                                        <controls:DataGridTextColumn Width="90" Header="Qty" Binding="{Binding Quantity, Mode=TwoWay}" />
                                        <controls:DataGridTextColumn Width="90" Header="Unit" Binding="{Binding Unit, Mode=TwoWay}" />
                                        <controls:DataGridTextColumn Width="130" Header="Netto/Pack" Binding="{Binding PackNetQuantity, Mode=TwoWay}" />
                                        <controls:DataGridTextColumn Width="170" Header="Harga/Pack (Rp)" Binding="{Binding PricePerPack, Mode=TwoWay, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100|nullable}" />
                                        <controls:DataGridTextColumn Width="170" Header="Manual Cost (Rp)" Binding="{Binding ManualCost, Mode=TwoWay, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100|nullable}" />
                                        <controls:DataGridTextColumn Width="160" Header="Total (Rp)" Binding="{Binding TotalCost, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" IsReadOnly="True" />
                                        <controls:DataGridCheckBoxColumn Width="90" Header="Dough" Binding="{Binding IncludeInDoughWeight, Mode=TwoWay}" />
                                    </controls:DataGrid.Columns>
                                </controls:DataGrid>
                            </ScrollViewer>
                        </StackPanel>
                    </Border>

                    <Border
                        Padding="10"
                        Background="{ThemeResource LayerFillColorAltBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="10">
                        <StackPanel Spacing="8">
                            <TextBlock FontSize="16" FontWeight="SemiBold" Text="Tenaga Kerja" />
                            <controls:DataGrid
                                AutoGenerateColumns="False"
                                GridLinesVisibility="All"
                                ItemsSource="{Binding LaborRoles}"
                                RowHeight="34"
                                SelectedItem="{Binding SelectedLaborRole, Mode=TwoWay}">
                                <controls:DataGrid.Columns>
                                    <controls:DataGridTextColumn Width="*" Header="Nama" Binding="{Binding Name, Mode=TwoWay}" />
                                    <controls:DataGridTextColumn Width="130" Header="Rate/Jam" Binding="{Binding HourlyRate, Mode=TwoWay}" />
                                    <controls:DataGridTextColumn Width="100" Header="Jam" Binding="{Binding Hours, Mode=TwoWay}" />
                                    <controls:DataGridTextColumn Width="160" Header="Total (Rp)" Binding="{Binding TotalCost, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" IsReadOnly="True" />
                                </controls:DataGrid.Columns>
                            </controls:DataGrid>
                            <Grid ColumnSpacing="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="120" />
                                    <ColumnDefinition Width="100" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <TextBox Grid.Column="0" Header="Nama Tenaga" Text="{Binding NewLaborName, Mode=TwoWay}" />
                                <TextBox Grid.Column="1" Header="Rate/Jam" Text="{Binding NewLaborRate, Mode=TwoWay}" />
                                <TextBox Grid.Column="2" Header="Jam" Text="{Binding NewLaborHours, Mode=TwoWay}" />
                                <Button Grid.Column="3" Margin="0,24,0,0" Command="{Binding AddLaborRoleCommand}" Content="Tambah" />
                                <Button Grid.Column="4" Margin="0,24,0,0" Command="{Binding RemoveLaborRoleCommand}" Content="Hapus" />
                            </Grid>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                <StackPanel Spacing="10">
                    <Border
                        Padding="10"
                        Background="{ThemeResource LayerFillColorAltBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="10">
                        <StackPanel Spacing="6">
                            <TextBlock FontSize="16" FontWeight="SemiBold" Text="Parameter Produksi &amp; Pricing" />
                            <TextBox Header="Output Teoritis" Text="{Binding TheoreticalOutput, Mode=TwoWay}" />
                            <TextBox Header="Waste (%)" Text="{Binding WastePercent, Mode=TwoWay}" />
                            <TextBox Header="Batch Multiplier" Text="{Binding BatchMultiplier, Mode=TwoWay}" />
                            <TextBox Header="Berat Donat (gram)" Text="{Binding DonutWeightGrams, Mode=TwoWay}" />
                            <CheckBox Content="Output berdasarkan berat adonan" IsChecked="{Binding UseWeightBasedOutput, Mode=TwoWay}" />
                            <TextBox Header="Topping/Donat (gram)" Text="{Binding ToppingWeightPerDonutGrams, Mode=TwoWay}" />
                            <TextBox Header="Berat Pack Topping (gram)" Text="{Binding ToppingPackWeightGrams, Mode=TwoWay}" />
                            <TextBox Header="Harga Pack Topping" Text="{Binding ToppingPackPrice, Mode=TwoWay}" />
                            <TextBox Header="Minyak Dipakai (liter)" Text="{Binding OilUsedLiters, Mode=TwoWay}" />
                            <TextBox Header="Harga Minyak / liter" Text="{Binding OilPricePerLiter, Mode=TwoWay}" />
                            <TextBox Header="Energi (kWh)" Text="{Binding EnergyKwh, Mode=TwoWay}" />
                            <TextBox Header="Tarif Energi" Text="{Binding EnergyRatePerKwh, Mode=TwoWay}" />
                            <TextBox Header="Overhead" Text="{Binding OverheadAllocated, Mode=TwoWay}" />
                            <TextBox Header="Packaging / unit" Text="{Binding PackagingPerUnit, Mode=TwoWay}" />
                            <ComboBox Header="Pricing Strategy" ItemsSource="{Binding PricingStrategies}" SelectedItem="{Binding PricingStrategy, Mode=TwoWay}" />
                            <TextBox Header="Markup (%)" Text="{Binding Markup, Mode=TwoWay}" />
                            <TextBox Header="Target Margin (%)" Text="{Binding TargetMarginPercent, Mode=TwoWay}" />
                            <TextBox Header="VAT (%)" Text="{Binding VatPercent, Mode=TwoWay}" />
                            <TextBox Header="Rounding Rule (contoh 100)" Text="{Binding RoundingRule, Mode=TwoWay}" />
                            <TextBox Header="Volatility (0..1)" Text="{Binding PriceVolatilityPercent, Mode=TwoWay}" />
                            <TextBox Header="Risk Appetite (0..1)" Text="{Binding RiskAppetitePercent, Mode=TwoWay}" />
                            <TextBox Header="Market Pressure (-0.5..0.5)" Text="{Binding MarketPressurePercent, Mode=TwoWay}" />
                            <TextBox Header="Target Profit / Batch" Text="{Binding TargetProfitPerBatch, Mode=TwoWay}" />
                            <TextBox Header="Monthly Fixed Cost" Text="{Binding MonthlyFixedCost, Mode=TwoWay}" />
                        </StackPanel>
                    </Border>

                    <Border
                        Padding="10"
                        Background="{ThemeResource LayerFillColorAltBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="10">
                        <StackPanel Spacing="6">
                            <TextBlock FontSize="16" FontWeight="SemiBold" Text="Hasil" />
                            <TextBlock Opacity="0.7" Text="Grand Total Modal" />
                            <TextBlock FontSize="18" FontWeight="SemiBold" Text="{Binding CalculationResult.TotalBatchCost, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" />
                            <TextBlock Opacity="0.7" Text="Modal / Donat" />
                            <TextBlock Text="{Binding CalculationResult.UnitCost, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" />
                            <TextBlock Opacity="0.7" Text="Harga Saran" />
                            <TextBlock Text="{Binding CalculationResult.SuggestedPrice, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" />
                            <TextBlock Opacity="0.7" Text="Range Harga" />
                            <TextBlock Text="{Binding CalculationResult.RecommendedPriceLow, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" />
                            <TextBlock Text="{Binding CalculationResult.RecommendedPriceHigh, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" />
                            <controls:DataGrid AutoGenerateColumns="False" GridLinesVisibility="All" ItemsSource="{Binding CostBreakdownRows}" RowHeight="30">
                                <controls:DataGrid.Columns>
                                    <controls:DataGridTextColumn Width="*" Header="Komponen" Binding="{Binding Component}" />
                                    <controls:DataGridTextColumn Width="160" Header="Nominal (Rp)" Binding="{Binding Amount, Converter={StaticResource RupiahRoundConverter}, ConverterParameter=100}" />
                                    <controls:DataGridTextColumn Width="90" Header="Porsi" Binding="{Binding Percent}" />
                                </controls:DataGrid.Columns>
                            </controls:DataGrid>
                        </StackPanel>
                    </Border>

                    <Border
                        Padding="10"
                        Background="{ThemeResource LayerFillColorAltBrush}"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1"
                        CornerRadius="10">
                        <StackPanel Spacing="6">
                            <TextBlock FontSize="16" FontWeight="SemiBold" Text="AI Assistant" />
                            <TextBlock Opacity="0.75" Text="{Binding AiConfigurationStatus}" TextWrapping="Wrap" />
                            <TextBox AcceptsReturn="True" Header="Smart Import Text" MinHeight="70" Text="{Binding AiImportRawText, Mode=TwoWay}" TextWrapping="Wrap" />
                            <Button Command="{Binding AiSmartImportCommand}" Content="AI Smart Import" />
                            <Button Command="{Binding AiNormalizeIngredientsCommand}" Content="Normalize Bahan" />
                            <Button Command="{Binding AiDetectAnomaliesCommand}" Content="Deteksi Anomali" />
                            <Button Command="{Binding AiForecastCommand}" Content="Forecast Pembelian" />
                            <TextBox AcceptsReturn="True" Header="What-if Prompt" MinHeight="70" Text="{Binding AiWhatIfPrompt, Mode=TwoWay}" TextWrapping="Wrap" />
                            <Button Command="{Binding AiWhatIfCommand}" Content="Run What-if" />
                            <TextBox AcceptsReturn="True" Header="Copilot Question" MinHeight="70" Text="{Binding AiCopilotQuestion, Mode=TwoWay}" TextWrapping="Wrap" />
                            <Button Command="{Binding AiCopilotCommand}" Content="Tanya Copilot" />
                            <TextBlock Text="{Binding AiPriceRecommendation}" TextWrapping="Wrap" />
                            <TextBlock Text="{Binding AiWhatIfSummary}" TextWrapping="Wrap" />
                            <TextBlock Text="{Binding AiAnomalyReport}" TextWrapping="Wrap" />
                            <TextBlock Text="{Binding AiForecastReport}" TextWrapping="Wrap" />
                            <TextBlock Text="{Binding AiCopilotAnswer}" TextWrapping="Wrap" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>
        </Grid>

        <Border
            Grid.Row="2"
            Padding="8"
            Background="{ThemeResource LayerFillColorAltBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="10">
            <TextBlock Text="{Binding StatusMessage}" TextWrapping="Wrap" />
        </Border>
    </Grid>
</Page>
